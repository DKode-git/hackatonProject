<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEO-PULSE // Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #C1FF72; --bg: #09090B; }
        body { background-color: var(--bg); color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        .font-heading { font-family: 'Space Grotesk', sans-serif; }
        
        /* Physics Animation Engine */
        .hover-spring { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hover-spring:hover { transform: scale(1.02) translateY(-4px); }
        
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glow-primary { box-shadow: 0 0 20px rgba(193, 255, 114, 0.2); }
        
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(30px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-entry { animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(193, 255, 114, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(193, 255, 114, 0); }
            100% { box-shadow: 0 0 0 0 rgba(193, 255, 114, 0); }
        }
        .pulse-btn { animation: pulse-glow 2s infinite; }

        /* Hydration Wave */
        .wave-container { position: relative; width: 80px; height: 180px; background: rgba(255, 255, 255, 0.05); border-radius: 40px; overflow: hidden; border: 2px solid rgba(255, 255, 255, 0.1); }
        .wave { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #C1FF72, #88ff00); transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>

<body class="h-screen flex">

    <aside class="w-20 md:w-24 border-r border-white/5 flex flex-col items-center py-8 gap-10">
        <div class="text-[#C1FF72] text-3xl mb-8"><i class="fa-solid fa-bolt"></i></div>
        <nav class="flex flex-col gap-8">
            <button onclick="window.location.href='dashboard.html'" class="nav-icon text-[#C1FF72] opacity-100 hover:opacity-100 transition-all text-xl">
                <i class="fa-solid fa-border-all"></i>
            </button>
            <button onclick="window.location.href='workout.html'" class="nav-icon text-white/40 hover:text-white transition-all text-xl">
                <i class="fa-solid fa-dumbbell"></i>
            </button>
            <button onclick="window.location.href='analytics.html'" class="nav-icon text-white/40 hover:text-white transition-all text-xl">
                <i class="fa-solid fa-chart-line"></i>
            </button>
        </nav>
        <div class="mt-auto">
            <button onclick="handleLogout()" class="text-red-400 hover:text-red-500 text-xl transition-colors" title="Terminate Session">
                <i class="fa-solid fa-power-off"></i>
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 md:p-10 relative">

        <header class="flex justify-between items-end mb-12 animate-entry">
            <div>
                <h2 class="text-white/50 uppercase tracking-[0.2em] text-xs font-bold mb-1">Status: Optimized</h2>
                <h1 class="text-4xl font-heading font-bold">COMMAND <span class="text-[#C1FF72]" id="user-display">CENTER</span></h1>
            </div>
            <div class="hidden md:block text-right">
                <p class="text-white/40 text-sm italic">"The only bad workout is the one that didn't happen."</p>
                <p class="text-xs font-mono mt-1 text-white/20" id="system-clock">SYSTEM_TIME: INITIALIZING...</p>
            </div>
        </header>

        <section id="dashboard" class="animate-entry" style="animation-delay: 0.1s;">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <div class="lg:col-span-2 glass rounded-3xl p-8 hover-spring">
                    <h3 class="font-heading text-lg mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-circle-nodes text-[#C1FF72]"></i> ACTIVE METRICS
                    </h3>
                    <div class="flex flex-wrap justify-around gap-8">
                        <div class="relative flex flex-col items-center">
                            <svg class="w-32 h-32 transform -rotate-90">
                                <circle cx="64" cy="64" r="58" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/5" />
                                <circle cx="64" cy="64" r="58" stroke="currentColor" stroke-width="8" fill="transparent"
                                    stroke-dasharray="364.4" stroke-dashoffset="364.4"
                                    class="text-[#C1FF72] transition-all duration-1000" id="steps-ring" />
                            </svg>
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center mt-[-4px]">
                                <span class="block text-xl font-bold font-heading" id="steps-val">--</span>
                                <span class="text-[10px] uppercase text-white/40">Steps</span>
                            </div>
                        </div>
                        <div class="relative flex flex-col items-center">
                            <svg class="w-32 h-32 transform -rotate-90">
                                <circle cx="64" cy="64" r="58" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/5" />
                                <circle cx="64" cy="64" r="58" stroke="currentColor" stroke-width="10"
                                    fill="transparent" stroke-dasharray="364.4" stroke-dashoffset="364.4"
                                    class="text-[#C1FF72] opacity-60 transition-all duration-1000" id="cal-ring" />
                            </svg>
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center mt-[-4px]">
                                <span class="block text-xl font-bold font-heading" id="cal-val">--</span>
                                <span class="text-[10px] uppercase text-white/40">Kcal</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-3xl p-8 hover-spring flex flex-col items-center">
                    <h3 class="font-heading text-lg mb-6 w-full"><i class="fa-solid fa-droplet text-cyan-400 mr-2"></i>HYDRATION</h3>
                    <div class="wave-container mb-6">
                        <div id="water-wave" class="wave" style="height: 0%;"></div>
                        <div class="absolute inset-0 flex items-center justify-center mix-blend-difference">
                            <span class="text-2xl font-bold font-heading" id="water-percent">0%</span>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="updateHydration(-10)" class="w-12 h-12 rounded-xl bg-white/5 hover:bg-white/10 active:scale-95 transition-all flex items-center justify-center border border-white/10">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                        <button onclick="updateHydration(10)" class="w-12 h-12 rounded-xl bg-[#C1FF72] text-black hover:opacity-90 active:scale-95 transition-all flex items-center justify-center">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="lg:col-span-3 glass rounded-3xl p-10 relative overflow-hidden group hover-spring">
                    <div class="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-bolt-lightning text-8xl text-[#C1FF72]"></i>
                    </div>
                    <div class="relative z-10">
                        <h2 class="text-2xl font-heading font-bold mb-2">READY FOR YOUR NEXT SESSION?</h2>
                        <p class="text-white/50 mb-8 max-w-md">System analysis complete. High recovery detected. Recommended: Lower Body Power.</p>
                        <button onclick="window.location.href='workout.html'" class="pulse-btn bg-[#C1FF72] text-black px-8 py-4 rounded-2xl font-bold tracking-wider hover:opacity-90 transition-all active:scale-95 flex items-center gap-3">
                            <i class="fa-solid fa-play"></i> START NEW WORKOUT
                        </button>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <script>
        // 1. CONFIGURATION
        const API_BASE_URL = "https://my-api-app-uqh7.onrender.com"; 

        // 2. AUTHENTICATION GUARD
        // Critical: Check who is logged in. If no one, kick them out.
        const CURRENT_USER_ID = localStorage.getItem('active_user_id');
        const CURRENT_USERNAME = localStorage.getItem('active_username');

        if (!CURRENT_USER_ID) {
            console.warn("Access Denied. No active session.");
            window.location.href = 'login.html';
        }

        // 3. STATE MANAGEMENT
        let appState = {
            steps: 0,
            stepGoal: 10000,
            calories: 0,
            calGoal: 2500,
            hydration: 0
        };

        // 4. FETCH WRAPPER (Now User-Aware)
        async function fetchUserData() {
            try {
                // Pass the USER_ID to get specific data
                const response = await fetch(`${API_BASE_URL}/api/v1/user/daily-stats?user_id=${CURRENT_USER_ID}`);
                
                if (response.status === 401) {
                    handleLogout(); // Token invalid
                    return;
                }
                
                if (!response.ok) throw new Error('API Offline or User Not Found');
                
                const data = await response.json();
                appState = data;
                
                // Set Header Name
                document.getElementById('user-display').innerText = CURRENT_USERNAME ? CURRENT_USERNAME.toUpperCase() : "OPERATOR";
                
                renderUI();

            } catch (e) {
                console.warn("[SYSTEM] API Connection Failed. Using Offline Mode.", e);
                // Fallback for demo purposes if backend is off
                renderUI(); 
            }
        }

        // 5. UI RENDER ENGINE
        function renderUI() {
            // Hydration
            document.getElementById('water-wave').style.height = `${appState.hydration}%`;
            document.getElementById('water-percent').innerText = `${appState.hydration}%`;

            // Steps Ring
            // Math: Circumference (364.4) - (Progress * Circumference)
            const stepsProgress = Math.min((appState.steps / appState.stepGoal), 1);
            const stepsOffset = 364.4 - (stepsProgress * 364.4);
            document.getElementById('steps-ring').style.strokeDashoffset = stepsOffset;
            document.getElementById('steps-val').innerText = (appState.steps / 1000).toFixed(1) + 'k';

            // Calories Ring
            const calProgress = Math.min((appState.calories / appState.calGoal), 1);
            const calOffset = 364.4 - (calProgress * 364.4);
            document.getElementById('cal-ring').style.strokeDashoffset = calOffset;
            document.getElementById('cal-val').innerText = (appState.calories / 1000).toFixed(1) + 'k';
        }

        // 6. ACTION: UPDATE HYDRATION
        async function updateHydration(amount) {
            // Optimistic UI Update (Instant feedback)
            let newLevel = appState.hydration + amount;
            if (newLevel > 100) newLevel = 100;
            if (newLevel < 0) newLevel = 0;
            
            appState.hydration = newLevel;
            renderUI();

            // Send to Backend
            try {
                await fetch(`${API_BASE_URL}/api/v1/user/hydrate`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: CURRENT_USER_ID, 
                        hydration: newLevel 
                    })
                });
            } catch (e) {
                console.error("Failed to save hydration", e);
            }
        }

        // 7. SYSTEM UTILITIES
        function handleLogout() {
            localStorage.removeItem('active_user_id');
            localStorage.removeItem('active_username');
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('system-clock').innerText = "SYSTEM_TIME: " + now.toLocaleTimeString();
        }

        // BOOT
        window.onload = function() {
            updateClock();
            setInterval(updateClock, 1000);
            fetchUserData();
        };
    </script>
</body>
</html>